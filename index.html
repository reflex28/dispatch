<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Upload and Display Modal</title>
    <style>
        /* Basic styling for modals */
        .modal {
            display: none; /* Ensure all modals are hidden on load */
            position: fixed; 
            z-index: 1; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0, 0, 0, 0.4); 
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border: 1px solid #888;
            width: 50%; 
            max-width: 600px;
            margin: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .input-container {
            margin-bottom: 20px;
        }

        .input-container label {
            margin-right: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table, th, td {
            border: 1px solid black;
        }

        th, td {
            padding: 8px;
            text-align: left;
        }

        .center-button {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
    </style>
    <!-- Include Firebase Library -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <h1>Upload and Display Data from Nanonets</h1>
    <div class="center-button">
        <button onclick="openModal('uploadModal')">Open Upload Modal</button>
    </div>

    <!-- File Upload Modal Structure -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Upload File</h2>
                <span class="close" onclick="closeModal('uploadModal')">&times;</span>
            </div>
            <div class="input-container">
                <input type="file" id="fileInput" accept="application/pdf">
                <button onclick="uploadFile()">Upload</button>
            </div>
        </div>
    </div>

    <!-- Data Display Modal Structure -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Extracted Table Data</h2>
                <span class="close" onclick="closeModal('myModal')">&times;</span>
            </div>
            <div class="input-container">
                <label for="salesOrder">Sales Order:</label>
                <input type="text" id="salesOrder" placeholder="Enter Sales Order">
                <label for="customer">Customer:</label>
                <input type="text" id="customer" placeholder="Enter Customer">
                <button onclick="submitData()">Submit</button>
            </div>
            <table id="resultTable">
                <!-- Table contents will be dynamically added here -->
            </table>
        </div>
    </div>
    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBe-uDZ1ne26PirlJMa5c3PV3QxPBMG_7E",
            authDomain: "sheppee-d4d79.firebaseapp.com",
            databaseURL: "https://sheppee-d4d79-default-rtdb.firebaseio.com",
            projectId: "sheppee-d4d79",
            storageBucket: "sheppee-d4d79.appspot.com",
            messagingSenderId: "107946020238",
            appId: "1:107946020238:web:8ab77b03da169a4548e8df",
            measurementId: "G-W08K75V77C"
        };
    
        try {
            firebase.initializeApp(firebaseConfig);
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }
    
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
    
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
    
        function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
    
            if (!file) {
                alert('Please select a file!');
                return;
            }
    
            const formData = new FormData();
            formData.append('file', file);
    
            const xhr = new XMLHttpRequest();
            xhr.addEventListener('readystatechange', function () {
                if (this.readyState === this.DONE) {
                    console.log(this.responseText);
                    const response = JSON.parse(this.responseText);
                    showModalWithTableData(response);
                    closeModal('uploadModal');
                }
            });
    
            xhr.open('POST', 'https://app.nanonets.com/api/v2/OCR/Model/46d317c6-77ce-4598-ab85-d04e2c7d4f5d/LabelUrls/?async=false');
            xhr.setRequestHeader('Authorization', 'Basic ' + btoa('bb8f0684-1da0-11ef-8b5b-2aeb7e4b6451:'));
            xhr.send(formData);
        }
    
        
        function showModalWithTableData(data) {
    const modal = document.getElementById('myModal');
    const table = document.getElementById('resultTable');
    
    // Clear any previous table data
    table.innerHTML = '';

    let headers = {};
    let isFirstTable = true; // Flag to identify the first table
    let globalRowIndex = 0; // Track the global row index across all tables

    // Check if data has results and iterate through them
    if (data && data.result) {
        data.result.forEach((resultItem) => {
            if (resultItem.prediction && resultItem.prediction.length > 0) {
                // Access the prediction array of the current result item
                const prediction = resultItem.prediction[0];
                const cells = prediction.cells;

                if (cells && cells.length > 0) {
                    const rows = {};

                    // Group cells by row and column to maintain order
                    cells.forEach(cell => {
                        if (!rows[cell.row]) {
                            rows[cell.row] = [];
                        }
                        rows[cell.row].push(cell);
                    });

                    // Sort rows by row number
                    const sortedRows = Object.keys(rows).sort((a, b) => parseInt(a) - parseInt(b));

                    sortedRows.forEach((rowNumber, index) => {
                        const rowCells = rows[rowNumber];
                        // Sort cells in the current row by column number
                        rowCells.sort((a, b) => a.col - b.col);

                        if (isFirstTable && index === 0) {
                            // Treat the first row of the first table as headers
                            rowCells.forEach(cell => {
                                headers[cell.col] = cell.text.trim();
                            });
                        } else if (index !== 0 || isFirstTable) {
                            // Ignore the first row of subsequent tables

                            // Create table rows for data
                            const row = document.createElement('tr');
                            row.dataset.globalRowIndex = globalRowIndex; // Store the global row index for later use
                            globalRowIndex++; // Increment global row index

                            rowCells.forEach(cell => {
                                const td = document.createElement('td');
                                td.textContent = cell.text;
                                td.dataset.header = headers[cell.col]; // Store header information
                                row.appendChild(td);
                            });
                            table.appendChild(row);
                        }
                    });

                    isFirstTable = false; // Set flag to false after processing the first table
                }
            }
        });
    } else {
        // If no data, display a message
        const noData = document.createElement('tr');
        const td = document.createElement('td');
        td.textContent = 'No data found';
        td.colSpan = 3; // Adjust based on the number of columns
        noData.appendChild(td);
        table.appendChild(noData);
    }

    // Show the modal
    openModal('myModal');
}

function submitData() {
    const salesOrder = document.getElementById('salesOrder').value;
    const customer = document.getElementById('customer').value;
    const table = document.getElementById('resultTable');
    const rows = table.querySelectorAll('tr');

    if (!salesOrder || !customer) {
        alert('Please enter both Sales Order and Customer information.');
        return;
    }

    // Create a new node under "Dispatch Test" in Firebase
    const newDispatchRef = firebase.database().ref('Dispatch Test').push();
    newDispatchRef.set({
        "Sales Order": salesOrder,
        "Customer": customer,
        "External Status": "Awaiting Packing" // Adding the new field
    }).then(() => {
        let rowIndex = 0; // Start row index at 0

        // Initialize an array to store row data in order
        let orderedRows = [];

        // Iterate through each row in the table
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length > 0) { // Check if it's not an empty row
                const rowData = {};
                let hasValidData = false; // Flag to check if there is any valid data in the row

                cells.forEach(cell => {
                    const headerText = cell.dataset.header;

                    if (headerText === "Item No" && cell.textContent.trim() !== "") {
                        rowData["Item No"] = cell.textContent;
                        hasValidData = true;
                    } else if (headerText === "Qty" && cell.textContent.trim() !== "") {
                        rowData["Qty"] = cell.textContent;
                        hasValidData = true;
                    } else if (headerText === "Part No" && cell.textContent.trim() !== "") {
                        if (cell.textContent === "PACKING") {
                            hasValidData = false; // Set flag to false to skip row
                            return; // Skip rows where "Part No" is "PACKING"
                        }
                        rowData["Part No"] = cell.textContent;
                        hasValidData = true;
                    }
                });

                if (hasValidData) {
                    orderedRows.push(rowData); // Add valid rowData to the orderedRows array
                    rowIndex++;
                }
            }
        });

        // Determine padding length based on the maximum number of rows (e.g., up to 999 rows)
        const paddingLength = 3; // Use fixed padding length of 3

        // Store all rows as an ordered list in Firebase with fixed-length, zero-padded keys
        orderedRows.forEach((rowData, index) => {
            // Create a zero-padded row key, e.g., "Row_001", "Row_002", "Row_010"
            const paddedIndex = String(index + 1).padStart(paddingLength, '0');
            const rowKey = `Row_${paddedIndex}`; // Construct the key with zero-padding

            // Debug log to check key format before saving
            console.log(`Saving data with key: ${rowKey}`, rowData);

            // Save the row data to Firebase under the constructed key
            newDispatchRef.child(rowKey).set(rowData);
        });

        alert('Data submitted successfully.');
        closeModal('myModal');
    }).catch(error => {
        console.error('Error writing data to Firebase:', error);
        alert('Failed to submit data. Please try again.');
    });
}


 
    
        
    </script>
    
    
</body>
</html>
